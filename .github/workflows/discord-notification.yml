name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed]
    branches:
      - main

jobs:
  notify-opened:
    runs-on: [self-hosted, on-premise]
    if: github.event.action == 'opened'
    steps:
      - name: Send Discord Notification - PR Opened
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          cat > /tmp/discord_payload.json << 'EOF'
          {
            "content": "ðŸ“ New PR Created!",
            "embeds": [
              {
                "title": "${{ env.PR_TITLE }}",
                "description": "${{ env.PR_BODY }}",
                "url": "${{ env.PR_URL }}",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${{ env.PR_AUTHOR }}",
                    "inline": true
                  },
                  {
                    "name": "From Branch",
                    "value": "${{ env.PR_HEAD_BRANCH }}",
                    "inline": true
                  },
                  {
                    "name": "To Branch",
                    "value": "${{ env.PR_BASE_BRANCH }}",
                    "inline": true
                  }
                ]
              }
            ]
          }
          EOF
          curl -X POST "$DISCORD_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @/tmp/discord_payload.json

  notify-merged:
    runs-on: [self-hosted, on-premise]
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Send Discord Notification - PR Merged
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          cat > /tmp/discord_payload.json << 'EOF'
          {
            "content": "ðŸŽ‰ PR Merged to Main!",
            "embeds": [
              {
                "title": "${{ env.PR_TITLE }}",
                "description": "${{ env.PR_BODY }}",
                "url": "${{ env.PR_URL }}",
                "color": 3066993,
                "fields": [
                  {
                    "name": "Author",
                    "value": "${{ env.PR_AUTHOR }}",
                    "inline": true
                  },
                  {
                    "name": "From Branch",
                    "value": "${{ env.PR_HEAD_BRANCH }}",
                    "inline": true
                  },
                  {
                    "name": "Merged By",
                    "value": "${{ env.PR_MERGED_BY }}",
                    "inline": true
                  }
                ]
              }
            ]
          }
          EOF
          curl -X POST "$DISCORD_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d @/tmp/discord_payload.json